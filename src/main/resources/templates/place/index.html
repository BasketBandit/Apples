<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="head"></head>
    <body>
        <div th:replace="banner"></div>
        <div class="container mt-1">
            <div id="colours" class="input-group justify-content-center mb-1">
                <a class="cbox border colourSelector" data-hex="B21F35" style="background-color:#B21F35"></a>
                <a class="cbox border colourSelector" data-hex="D82735" style="background-color:#D82735"></a>
                <a class="cbox border colourSelector" data-hex="FF7435" style="background-color:#FF7435"></a>
                <a class="cbox border colourSelector" data-hex="FFA135" style="background-color:#FFA135"></a>
                <a class="cbox border colourSelector" data-hex="FFB470" style="background-color:#FFB470"></a>
                <a class="cbox border colourSelector" data-hex="FFCB35" style="background-color:#FFCB35"></a>
                <a class="cbox border colourSelector" data-hex="FFF735" style="background-color:#FFF735"></a>
                <a class="cbox border colourSelector" data-hex="00753A" style="background-color:#00753A"></a>
                <a class="cbox border colourSelector" data-hex="009E47" style="background-color:#009E47"></a>
                <a class="cbox border colourSelector" data-hex="16DD36" style="background-color:#16DD36"></a>
                <a class="cbox border colourSelector" data-hex="0052A5" style="background-color:#0052A5"></a>
                <a class="cbox border colourSelector" data-hex="0079E7" style="background-color:#0079E7"></a>
                <a class="cbox border colourSelector" data-hex="06A9FC" style="background-color:#06A9FC"></a>
                <a class="cbox border colourSelector" data-hex="681E7E" style="background-color:#681E7E"></a>
                <a class="cbox border colourSelector" data-hex="7D3CB5" style="background-color:#7D3CB5"></a>
                <a class="cbox border colourSelector" data-hex="BD7AF6" style="background-color:#BD7AF6"></a>
                <a class="cbox border colourSelector" data-hex="FF99AA" style="background-color:#FF99AA"></a>
                <a class="cbox border colourSelector" data-hex="9C6926" style="background-color:#9C6926"></a>
                <a class="cbox border colourSelector" data-hex="6D482F" style="background-color:#6D482F"></a>
                <a class="cbox border colourSelector" data-hex="000000" style="background-color:#000000"></a>
                <a class="cbox border colourSelector" data-hex="222222" style="background-color:#222222"></a>
                <a class="cbox border colourSelector" data-hex="444444" style="background-color:#444444"></a>
                <a class="cbox border colourSelector border-primary" data-hex="FFFFFF" style="background-color:#FFFFFF"></a>
                <a class="cbox border colourSelector" data-hex="DDDDDD" style="background-color:#DDDDDD"></a>
                <a class="cbox border colourSelector" data-hex="BBBBBB" style="background-color:#BBBBBB"></a>
            </div>
        </div>

        <div class="canvas-container text-center d-flex justify-content-center">
            <canvas id="canvas" width="250" height="141"></canvas>
        </div>
        <div id="coords" class="text-center"></div>

        <script type="text/javascript" th:inline="javascript">
            $(document).ready(function() {
                const canvas = document.querySelector('canvas');
                const ctx = canvas.getContext('2d', {antialias: false});

                var image = new Image();
                image.onload = function() {
                    ctx.drawImage(image, 0, 0);
                };
                image.src = [[${"data:image/png;base64,"+image}]];

                var selectedColour = "ffffff";

                function connect() {
                    ws = new WebSocket('ws://localhost:' + location.port +'/place/events'); //3.9.0.140
                    ws.onmessage = function(data){
                        update(data.data);
                    }
                    console.log("Connected to the server...");
                }

                function disconnect() {
                    if(ws != null) {
                        ws.close();
                    }
                    console.log("Disconnected from the server...");
                }

                function send() {
                    ws.send();
                }

                function update(data) {
                    if(data.startsWith("place:")) {
                        var segment = data.substring(6, data.length).split(',');
                        ctx.fillStyle = "#" + segment[2];
                        ctx.fillRect(segment[0], segment[1], 1, 1); // x, y, w, h
                        return;
                    }
                }

                canvas.addEventListener('mousedown', (e) => {
                    var mouseX = e.clientX - canvas.offsetLeft;
                    var mouseY = e.clientY - canvas.offsetTop;
                    var x = Math.floor(mouseX * canvas.width / canvas.clientWidth);
                    var y = Math.floor(mouseY * canvas.height / canvas.clientHeight);
                    ws.send("place:" + x + "," + y + "," + selectedColour);
                });

                canvas.addEventListener('mousemove', (e) => {
                    var mouseX = e.clientX - canvas.offsetLeft;
                    var mouseY = e.clientY - canvas.offsetTop;
                    var x = Math.floor(mouseX * canvas.width / canvas.clientWidth);
                    var y = Math.floor(mouseY * canvas.height / canvas.clientHeight);
                    $('#coords').text("x: "+x+", y: "+y);
                });

                $('.colourSelector').on('click', function() {
                    selectedColour = $(this).data('hex');
                    $('a').removeClass('border-primary');
                    $(this).addClass('border-primary');
                })

                connect();
            })
        </script>
    </body>
</html>